<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Ticket Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="shortcut icon" href="repair_system/static/favicon.ico" type="image/x-icon">
</head>
<body class="bg-gray-100 min-h-screen">

<!-- Notifications -->
<div class="container mx-auto max-w-4xl mt-6">
  {% if messages %}
    <div class="space-y-2">
      {% for message in messages %}
        <div class="px-4 py-2 rounded
          {% if message.tags == 'success' %}bg-green-200 text-green-800
          {% elif message.tags == 'error' %}bg-red-200 text-red-800
          {% else %}bg-gray-200 text-gray-800{% endif %} transition-all">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<section class="p-6 bg-gray-100 min-h-screen">
  <div class="container mx-auto max-w-4xl">
    <a href="{% url 'staff:dashboard' %}" class="text-blue-600 hover:underline mb-4 inline-block">&larr; Back to Dashboard</a>

    <div class="bg-white p-6 rounded-lg shadow mb-6">
      <h2 class="text-2xl font-bold mb-4">Ticket {{ ticket.tracking_id }}</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p><strong>Client:</strong> {{ ticket.client.first_name }} {{ ticket.client.last_name }}</p>
          <p><strong>Phone:</strong> {{ ticket.client_phone|default:"N/A" }}</p>
          <p><strong>Email:</strong> {{ ticket.client.email }}</p>
        </div>
        <div>
          <p><strong>Device:</strong> {{ ticket.device_type }} – {{ ticket.device_model }}</p>
          <p><strong>Status:</strong>
              <span class="px-2 py-1 rounded-full text-white
                {% if ticket.status == 'open' %}bg-green-500
                {% elif ticket.status == 'in_progress' %}bg-yellow-500
                {% else %}bg-gray-500{% endif %}">
                {{ ticket.status|title }}
              </span>
          </p>
        </div>
      </div>

      <div class="mt-4">
        <p><strong>Description:</strong><br>{{ ticket.description }}</p>
      </div>

      {% if ticket.device_photo %}
      <div class="mt-4">
        <p class="font-semibold">Device Photo:</p>
        <img src="{{ ticket.device_photo.url }}" class="mt-2 rounded shadow max-h-64">
      </div>
      {% endif %}

      <!-- Price & Status Update Form -->
      <div class="mt-6 bg-gray-50 p-4 rounded shadow">
        <form id="updateForm" method="post" action="{% url 'staff:update_ticket_status' ticket.id %}" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
          {% csrf_token %}

          <!-- Status -->
          <div>
            <label class="block mb-1 font-semibold" for="status">Status</label>
            <select id="status" name="status" class="border px-3 py-2 rounded w-full">
              <option value="open" {% if ticket.status == 'open' %}selected{% endif %}>Open</option>
              <option value="in_progress" {% if ticket.status == 'in_progress' %}selected{% endif %}>In Progress</option>
              <option value="closed" {% if ticket.status == 'closed' %}selected{% endif %}>Closed</option>
            </select>
          </div>

          <!-- Price -->
          <div>
            <label class="block mb-1 font-semibold" for="price">Estimated Price (€)</label>
            <input type="number" step="0.01" name="price" id="price" value="{{ ticket.estimated_price }}" class="border px-3 py-2 rounded w-full">
          </div>

          <!-- Staff Note -->
          <div class="md:col-span-2">
            <label class="block mb-1 font-semibold" for="staff_note">Nachricht an den Kunden</label>
            <textarea name="staff_note" id="staff_note" rows="4" placeholder="Schreiben Sie hier eine Nachricht für den Kunden..." class="border px-3 py-2 rounded w-full"></textarea>
          </div>

          <!-- Buttons -->
          <div class="md:col-span-2 flex gap-3 mt-2">
            <button type="submit" onclick="return confirmUpdate()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
              Save & Notify Client
            </button>

            <!-- Classic link -->
           

            <!-- Styled popup button -->
            <button type="button" id="printBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                Print Ticket
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</section>

<script>
  // Fade-out notifications
  setTimeout(() => {
    document.querySelectorAll('.transition-all').forEach(el => {
      el.classList.add('opacity-0', 'transition', 'duration-700', 'ease-out');
    });
  }, 3000);

  // Confirm + Submit for Save & Notify
  function confirmUpdate() {
    return confirm("Are you sure you want to update the ticket and notify the client?");
  }

  // Print button
  document.getElementById('printBtn').addEventListener('click', function() {
    const printUrl = "{% url 'staff:print_ticket' ticket.id %}";
    const printWindow = window.open(printUrl, 'Print Ticket', 'width=400,height=600');

    printWindow.onload = function() {
      printWindow.focus();
      printWindow.print();
    };

    // Optional: auto-close popup and redirect main page
    /*
    printWindow.onafterprint = function() {
        printWindow.close();
        window.location.href = "{% url 'staff:dashboard' %}";
    };
    */
  });
</script>

</body>
</html>